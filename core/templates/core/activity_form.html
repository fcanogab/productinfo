{% extends "base.html" %}

{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<div class="row col-md-6">
    <h1>New activity</h1>
    <form action="" method="post">
        {% csrf_token %}
        {% for field in form %}
          {% if field.name != 'requirements' %}
            {{ field|as_crispy_field }}
          {% endif %}
        {% endfor %}

        {% if form.fields.requirements %}
            <h3>Requirements</h3>
            {% regroup form.fields.requirements.queryset by standard as standard_list %}
            <div id="requirements_formset">
                {% for group in standard_list %}
                <div class="mb-3">
                    <strong>{{ group.grouper.name }}</strong>
                    <button class="btn btn-link btn-sm" type="button" onclick="toggleRequirements('requirements_list_{{ forloop.counter0 }}')">
                        Show/Hide Requirements
                    </button>
                    <div id="requirements_list_{{ forloop.counter0 }}" style="margin-left: 2em; display: none;">
                    {% for requirement in group.list %}
                        <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                            name="requirements" value="{{ requirement.pk }}"
                            id="requirement_{{ requirement.pk }}"
                            {% if requirement.pk|stringformat:'s' in form.initial.requirements|stringformat:'s' or requirement.pk|stringformat:'s' in form.data.requirements|stringformat:'s' %}checked{% endif %}>
                        <label class="form-check-label" for="requirement_{{ requirement.pk }}">
                            {{ requirement.name }}{% if requirement.code %} ({{ requirement.code }}){% endif %}: {{ requirement.definition }}
                        </label>
                        </div>
                    {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}

        <h3>Jira Tickets</h3>
        {{ jira_formset.management_form }}
        <div id="jira_formset">
            {% for form in jira_formset %}
                <div class="dynamic-form">{{ form }}</div>
            {% endfor %}
        </div>
        <button type="button" id="add-jira">Add another Jira Ticket</button>

        <h3>Results</h3>
        {{ result_formset.management_form }}
        <div id="result_formset">
            {% for form in result_formset %}
                <div class="dynamic-form">{{ form }}</div>
            {% endfor %}
        </div>
        <button type="button" id="add-result">Add another Result</button>

        <h3>Documents</h3>
        {{ document_formset.management_form }}
        <div id="document_formset">
            {% for form in document_formset %}
                <div class="dynamic-form">{{ form }}</div>
            {% endfor %}
        </div>
        <button type="button" id="add-document">Add another Document</button>
        <input type="submit" value="Submit" class="btn btn-primary" />
    </form>
</div>

<script src="{% static 'js/formset.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script src="/static/core/js/custom.js"></script>
{% endblock %}
